/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   colors.c                                           :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/07 11:28:56 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/11 18:09:35 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

int	color_from_iter(int iter, int max_iter)
{
	double	t;
	int		r;
	int		g;
	int		b;
	int		a;

	if (iter >= max_iter)
		return (0x000000);
	t = (double)iter / max_iter;
	r = (0 + t * 100);
	g = (0 + t * 180);
	b = (51 + t * 204);
	a = ((r << 16) | (g << 8) | b);
	return (a);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   events.c                                           :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/07 11:28:51 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/12 17:06:09 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

#define KEY_ESC 65307
#define KEY_PLUS 61
#define KEY_MINUS 45
#define KEY_LEFT 65361
#define KEY_RIGHT 65363
#define KEY_UP 65362
#define KEY_DOWN 65364

static void	move_keys(int keycode, t_fractol *f)
{
	if (keycode == KEY_LEFT)
		f->offset_x -= 0.05 / f->zoom;
	else if (keycode == KEY_RIGHT)
		f->offset_x += 0.05 / f->zoom;
	else if (keycode == KEY_UP)
		f->offset_y -= 0.05 / f->zoom;
	else if (keycode == KEY_DOWN)
		f->offset_y += 0.05 / f->zoom;
	else if (keycode == KEY_PLUS)
		f->zoom *= 1.1;
	else if (keycode == KEY_MINUS)
		f->zoom /= 1.1;
}

int	key_hook(int keycode, void *param)
{
	t_fractol	*f;

	f = (t_fractol *)param;
	if (keycode == KEY_ESC)
		close_hook(f);
	move_keys(keycode, f);
	render(f);
	return (0);
}

int	mouse_hook(int button, int x, int y, void *param)
{
	t_fractol	*f;

	f = (t_fractol *)param;
	(void)x;
	(void)y;
	if (button == 4)
		f->zoom *= 1.1;
	else if (button == 5)
		f->zoom /= 1.1;
	render(f);
	return (0);
}

void	close_hook(void *param)
{
	t_fractol	*f;

	f = (t_fractol *)param;
	if (f->win)
		mlx_destroy_window(f->mlx, f->win);
	if (f->img.img)
		mlx_destroy_image(f->mlx, f->img.img);
	if (f->mlx)
	{
		mlx_destroy_display(f->mlx);
		free(f->mlx);
	}
	exit(0);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   init.c                                             :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/07 11:28:38 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/12 20:25:35 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

static int	create_image(t_fractol *f)
{
	f->img.img = mlx_new_image(f->mlx, WIN_W, WIN_H);
	if (!f->img.img)
		return (0);
	f->img.addr = mlx_get_data_addr(f->img.img, &f->img.bpp, &f->img.line_len,
			&f->img.endian);
	if (!f->img.addr)
		return (0);
	return (1);
}

int	init_fractol(t_fractol *f)
{
	f->mlx = mlx_init();
	if (!f->mlx)
		close_hook(f);
	f->win = mlx_new_window(f->mlx, WIN_W, WIN_H, "fractol");
	if (!f->win)
		close_hook(f);
	if (!create_image(f))
		close_hook(f);
	f->zoom = 1.0;
	f->offset_x = 0.0;
	f->offset_y = 0.0;
	f->max_iter = 100;
	if (f->fractal == 0)
		f->offset_x = -0.5;
	mlx_hook(f->win, 2, 1L << 0, key_hook, f);
	mlx_mouse_hook(f->win, mouse_hook, f);
	mlx_hook(f->win, 17, 0L, (void *)close_hook, f);
	return (1);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   julia.c                                            :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/07 11:29:50 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/12 20:20:13 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

int	julia_iter(t_complex z, t_complex c, int max_iter)
{
	long double	tmp;
	int			i;

	i = 0;
	while (z.r * z.r + z.i * z.i <= 4.0 && i < max_iter)
	{
		tmp = z.r * z.r - z.i * z.i + c.r;
		z.i = 2.0 * z.r * z.i + c.i;
		z.r = tmp;
		i++;
	}
	return (i);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   main.c                                             :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/11 13:12:21 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/12 20:13:27 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

static void	usage(void)
{
	write(1, "Usage:\n", 7);
	write(1, "  ./fractol mandelbrot\n", 23);
	write(1, "  ./fractol julia <real> <imag>\n", 32);
}

static int	ft_strncmp(const char *s1, const char *s2, size_t n)
{
	size_t	i;

	i = 0;
	while (i < n && s1[i] && s1[i] == s2[i])
		i++;
	if (i == n)
		return (0);
	return ((unsigned char)s1[i] - (unsigned char)s2[i]);
}

static int	parse_julia(int argc, char **argv, t_fractol *f)
{
	if (argc == 4)
	{
		if (!is_valid_double(argv[2]) || !is_valid_double(argv[3]))
		{
			error_exit("Error: parameters must be numbers\n");
			return (0);
		}
		f->jc.r = ft_a2double(argv[2]);
		f->jc.i = ft_a2double(argv[3]);
		if (!in_range(f->jc.r) || !in_range(f->jc.i))
		{
			error_exit("Error: parameters must be within [-2, 2]\n");
			return (0);
		}
	}
	else
	{
		f->jc.r = -0.835;
		f->jc.i = -0.2321;
	}
	return (1);
}

int	parse_args(int argc, char **argv, t_fractol *f)
{
	if (argc == 2 && ft_strncmp(argv[1], "mandelbrot", 11) == 0)
	{
		f->fractal = 0;
		return (1);
	}
	if ((argc == 2 || argc == 4) && ft_strncmp(argv[1], "julia", 6) == 0)
	{
		f->fractal = 1;
		return (parse_julia(argc, argv, f));
	}
	usage();
	return (0);
}

int	main(int argc, char **argv)
{
	t_fractol	f;

	f.zoom = 1.0;
	f.offset_x = 0.0;
	f.offset_y = 0.0;
	f.max_iter = 100;
	if (!parse_args(argc, argv, &f))
		return (0);
	if (!init_fractol(&f))
	{
		error_exit("Failed to initialize MLX\n");
		return (0);
	}
	render(&f);
	mlx_loop(f.mlx);
	return (0);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   mandelbrot.c                                       :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/07 11:29:59 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/11 13:45:26 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

int	mandelbrot_iter(t_complex z, t_complex c, int max_iter)
{
	double	tmp;
	int		i;

	i = 0;
	while (z.r * z.r + z.i * z.i <= 4.0 && i < max_iter)
	{
		tmp = z.r * z.r - z.i * z.i + c.r;
		z.i = 2.0 * z.r * z.i + c.i;
		z.r = tmp;
		i++;
	}
	return (i);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   render.c                                           :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/07 11:27:22 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/12 18:06:01 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

void	put_pixel(t_img *img, int x, int y, int color)
{
	char	*dst;
	int		offset;

	if (x < 0 || x >= WIN_W || y < 0 || y >= WIN_H)
		return ;
	offset = (y * img->line_len) + (x * (img->bpp / 8));
	dst = img->addr + offset;
	*(unsigned int *)dst = (unsigned int)color;
}

static void	draw_pixel(t_fractol *f, int x, int y)
{
	int			iter;
	t_complex	z;
	t_complex	c;

	c.r = map_x(x, f);
	c.i = map_y(y, f);
	if (f->fractal == 0)
	{
		z.r = 0.0;
		z.i = 0.0;
		iter = mandelbrot_iter(z, c, f->max_iter);
	}
	else
	{
		z.r = c.r;
		z.i = c.i;
		iter = julia_iter(z, f->jc, f->max_iter);
	}
	put_pixel(&f->img, x, y, color_from_iter(iter, f->max_iter));
}

void	render(t_fractol *f)
{
	int	x;
	int	y;

	y = 0;
	while (y < WIN_H)
	{
		x = 0;
		while (x < WIN_W)
		{
			draw_pixel(f, x, y);
			x++;
		}
		y++;
	}
	mlx_put_image_to_window(f->mlx, f->win, f->img.img, 0, 0);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   utils2.c                                           :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/11 13:07:52 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/11 15:18:52 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

int	is_valid_double(const char *s)
{
	int	dot;
	int	digit;

	dot = 0;
	digit = 0;
	if (!s || *s == '\0')
		return (0);
	if (*s == '+' || *s == '-')
		s++;
	while (*s)
	{
		if (*s == '.')
		{
			if (dot)
				return (0);
			dot = 1;
		}
		else if (*s >= '0' && *s <= '9')
			digit = 1;
		else
			return (0);
		s++;
	}
	return (digit);
}

static double	parse_fraction(const char *s, double res)
{
	double	frac;

	frac = 0.1;
	while (*s >= '0' && *s <= '9')
	{
		res += (*s - '0') * frac;
		frac *= 0.1;
		s++;
	}
	return (res);
}

double	ft_a2double(const char *s)
{
	double	res;
	int		sign;

	res = 0.0;
	sign = 1;
	if (!s)
		return (0.0);
	while ((*s == 32) || (*s >= 9 && *s <= 13))
		s++;
	if (*s == '-' || *s == '+')
	{
		if (*s == '-')
			sign = -1;
		s++;
	}
	while (*s >= '0' && *s <= '9')
		res = (res * 10.0 + (*s++ - '0'));
	if (*s == '.')
	{
		s++;
		res = parse_fraction(s, res);
	}
	return (res * sign);
}

int	in_range(double v)
{
	if (v >= -2.0 && v <= 2.0)
		return (1);
	return (0);
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   utils.c                                            :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/07 11:27:49 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/12 20:20:31 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "fractol.h"

static size_t	ft_strlen(const char *s)
{
	size_t	i;

	i = 0;
	while (s[i] != '\0')
	{
		i++;
	}
	return (i);
}

double	map_x(int x, t_fractol *f)
{
	double	range;

	range = 3.5 / f->zoom;
	return ((x - WIN_W / 2.0) * (range / WIN_W) + f->offset_x);
}

double	map_y(int y, t_fractol *f)
{
	double	range;
	double	aspect;

	aspect = (double)WIN_H / (double)WIN_W;
	range = (3.5 * aspect) / f->zoom;
	return (-((y - WIN_H / 2.0) * (range / WIN_H) + f->offset_y));
}

void	error_exit(const char *msg)
{
	if (msg)
	{
		write(2, msg, ft_strlen(msg));
	}
	return ;
}
/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   fractol.h                                          :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: malsabah <malsabah@student.42amman.com>    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2026/01/07 11:42:43 by malsabah          #+#    #+#             */
/*   Updated: 2026/01/20 19:34:52 by malsabah         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#ifndef FRACTOL_H
# define FRACTOL_H

# include "mlx.h"
# include <math.h>
# include <stdlib.h>
# include <unistd.h>
# define WIN_W 200
# define WIN_H 200

typedef struct s_complex
{
	double		r;
	double		i;
}				t_complex;

typedef struct s_img
{
	void		*img;
	char		*addr;
	int			bpp;
	int			line_len;
	int			endian;
}				t_img;

typedef struct s_fractol
{
	void		*mlx;
	void		*win;
	t_img		img;
	double		zoom;
	double		offset_x;
	double		offset_y;
	int			max_iter;
	int			fractal;
	t_complex	jc;
}				t_fractol;

int				is_valid_double(const char *s);
int				in_range(double v);
double			ft_a2double(const char *s);
int				parse_args(int argc, char **argv, t_fractol *f);
int				init_fractol(t_fractol *f);
int				key_hook(int keycode, void *param);
int				mouse_hook(int button, int x, int y, void *param);
void			close_hook(void *param);
void			render(t_fractol *f);
void			put_pixel(t_img *img, int x, int y, int color);
void			error_exit(const char *msg);
int				mandelbrot_iter(t_complex z, t_complex c, int max_iter);
int				julia_iter(t_complex z, t_complex c, int max_iter);
double			map_x(int x, t_fractol *f);
double			map_y(int y, t_fractol *f);
int				color_from_iter(int iter, int max_iter);

#endif